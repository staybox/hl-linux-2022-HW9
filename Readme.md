# Otus HW9 Виртуализация: Proxmox (course: hl-linux-2022)

```
Домашнее задание
развертывание виртуальных машин на proxmox с помощью terraform

Цель:
terraform скрипты для развертывания виртуальных машин на проксмоксе
```

## Характеристики системы

ОС - Debian 11
Ядро - Linux 5.15.39-1-pve
Гипервизор - ProxmoxVE 7.2-7

## Подготовительные мероприятия

1. Необходимо убедиться, что у вас создан vmbrX интерфейс для того чтобы в дальнейнем его можно было связать с созданной виртуальной машиной. Этот виртуальный интерфейс необходим для внутренней "серой" IP адресации.

Пример конфигурационного файла ```/etc/network/interfaces```:
```
# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!

source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
	address <ВНЕШНИЙ IP>
	gateway <ШЛЮЗ ДЛЯ ВНЕШНЕГО IP>
	dns-nameservers <IP ДНС СЕРВЕРА> <IP ДНС СЕРВЕРА>

auto vmbr10 # имя может быть любое
iface vmbr10 inet static
address 192.168.10.1
netmask 255.255.255.0
bridge_ports none
bridge_stp off
bridge_fd 0

# Данные строки необходимы для того чтобы у ВМ изнутри был доступ к интернету
post-up echo 1 > /proc/sys/net/ipv4/ip_forward
post-up   iptables -t nat -A POSTROUTING -s '192.168.10.0/24' -o eth0 -j MASQUERADE
post-down iptables -t nat -D POSTROUTING -s '192.168.10.0/24' -o eth0 -j MASQUERADE
```

Для того чтобы перезапустить сетевую подсистему можно использовать ```sudo systemctl restart networking.service```

Также можно установить пакет для удобного выключения/включения конкретного сетевого интерфейса ```sudo apt install ifupdown2```

Необходимо проверить что у вас виден бридж интерфейс в веб-интерфейсе.

2. Необходимо создать шаблон ВМ для того чтобы в дальнейшем вы смогли с помощью терраформа клонировать (создавать по его образцу) новые виртуальные машины.

- Переходим в директорию storage (local) по умолчанию ```cd /var/lib/vz/template/iso```

- Скачиваем cloud-init образ ОС ```http://cloud-images.ubuntu.com/releases/focal/release/ubuntu-20.04-server-cloudimg-amd64.img```

- Далее нам необходимо скачать прикладное ПО, которое может кастомизировать наш скачанный img ```sudo apt install libguestfs-tools -y```

- Выполняем команду для того чтобы интегрировать в наш будущий шаблон (а сейчас образ ОС) агент Proxmox ```sudo virt-customize -a ubuntu-20.04-server-cloudimg-amd64.img --install qemu-guest-agent```

- Далее мы создаем ВМ:
```
qm create 9001 \
  --name ubuntu-2004-cloud-init --numa 0 --ostype l26 \
  --cpu cputype=host --cores 2 --sockets 1 \
  --memory 1024  \
  --net0 virtio,bridge=vmbr10
  ```

- Импортируем образ в пул хранения ```qm importdisk 9001 ubuntu-20.04-server-cloudimg-amd64.img local```

- Присоединяем диск к ВМ ```qm set 9001 --scsihw virtio-scsi-pci --scsi0 local:9001/vm-9001-disk-0.raw```

- Создаем для ВМ CD-ROM ```qm set 9001 --ide2 local:cloudinit```

- Делаем наш диск загрузочным (который будет своим для каждой новой ВМ)```qm set 9001 --boot c --bootdisk scsi0```

- Делаем возможным работать через веб-консоль для управления ВМ ```qm set 9001 --serial0 socket --vga serial0```

- Включаем по умолчанию гостевого агента ```qm set 9001 --agent enabled=1```

- Конвертируем ВМ в шаблон командой ```qm template 9001```

3. В веб-интерфейсе Proxmox необходимо:

- Создать API ключ для создания ВМ через Terraform
![Image 1](https://raw.githubusercontent.com/staybox/hl-linux-2022-HW9/main/screenshots/proxmox_storage_perm.jpg)

- Добавить права доступа в разделе ```permissions``` для storage через API
![Image 2](https://raw.githubusercontent.com/staybox/hl-linux-2022-HW9/main/screenshots/proxmox_api.jpg)

После разворачивания ВМ (на моем примере у меня две ВМ) картина буде приблизительно следующей:
![Image 3](https://raw.githubusercontent.com/staybox/hl-linux-2022-HW9/main/screenshots/proxmox_result.jpg)

## Запуск

1. Скачать и установить Terraform, Git

2. Сгенерировать открытый и закрытый ключ для ВМ командой ```ssh-keygen```

3. Склонировать репозиторий ```git clone https://github.com/staybox/hl-linux-2022-HW9.git```

4. Привести к рабочему виду файл variables.tf, внеся в него данные актуальные данные от вашего Proxmox

5. Выполнить команду ```terraform init``` в папке проекта

6. Выполнить команду ```terraform apply```. Перед использование команды ```terraform apply```, рекомендуется использовать ```terraform plan```

Команда для более быстрой подготовки к запуску: ```mkdir hl-linux-2022-HW9 && cd hl-linux-2022-HW9 && git clone https://github.com/staybox/hl-linux-2022-HW9.git && terraform init && terraform validate```